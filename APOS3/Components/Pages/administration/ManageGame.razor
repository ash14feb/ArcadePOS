@page "/administration/manage-game"
@using Microsoft.AspNetCore.Components
@using APOS3.DataAccess.Repos
@using APOS3.Models
@inject NavigationManager NavigationManager
@inject IGameRepository GameRepository

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-purple-50/30 p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between gap-4 items-start">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-white rounded-2xl shadow-sm border border-gray-100">
                        <span class="material-symbols-outlined text-3xl text-purple-600">casino</span>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold bg-gradient-to-r from-gray-900 to-purple-800 bg-clip-text text-transparent">
                            Manage Games
                        </h1>
                        <p class="text-gray-600 mt-2 flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">sports_esports</span>
                            Add, edit, and manage your game library
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button @onclick="GoBack"
                            class="flex items-center gap-3 rounded-2xl px-6 py-3 bg-white text-gray-700 border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-all duration-300 shadow-sm hover:shadow-md">
                        <span class="material-symbols-outlined">arrow_back</span>
                        <span class="text-sm font-semibold">Back</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add New Game Card -->
        <div class="bg-white rounded-2xl border border-gray-200/80 p-6 mb-8 shadow-lg">
            <div class="flex items-center gap-3 mb-6">
                <span class="material-symbols-outlined text-green-500 text-2xl">add_circle</span>
                <h3 class="text-2xl font-bold text-gray-900">@(isEditing ? "Edit Game" : "Add New Game")</h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Game Name -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Game Name *</label>
                    <input @bind="newGame.game_name" 
                           type="text" 
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-purple-500 focus:ring-purple-500 shadow-sm transition-colors"
                           placeholder="Enter game name" />
                    @if (HasValidationError("game_name"))
                    {
                        <p class="text-red-500 text-xs mt-1">@GetValidationError("game_name")</p>
                    }
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="status" @onchange='() => UpdateStatus("ACTIVE")' 
                                   checked='@(newGame.status == "ACTIVE")'
                                   class="text-purple-600 focus:ring-purple-500" />
                            <span class="text-gray-700">Active</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="status" @onchange='() => UpdateStatus("INACTIVE")' 
                                   checked='@(newGame.status == "INACTIVE")'
                                   class="text-purple-600 focus:ring-purple-500" />
                            <span class="text-gray-700">Inactive</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 mt-6">
                @if (isEditing)
                {
                    <button @onclick="UpdateGame"
                            class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl hover:from-purple-600 hover:to-pink-700 transition-all duration-300 shadow-lg hover:shadow-xl font-semibold">
                        <span class="material-symbols-outlined">save</span>
                        Update Game
                    </button>
                    <button @onclick="CancelEdit"
                            class="flex items-center gap-2 px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all duration-300 shadow-lg hover:shadow-xl font-semibold">
                        <span class="material-symbols-outlined">cancel</span>
                        Cancel
                    </button>
                }
                else
                {
                    <button @onclick="AddGame"
                            class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl font-semibold">
                        <span class="material-symbols-outlined">add</span>
                        Add Game
                    </button>
                }
            </div>
        </div>

        <!-- Games List Card -->
        <div class="bg-white rounded-2xl border border-gray-200/80 shadow-xl overflow-hidden">
            <!-- Card Header -->
            <div class="px-6 py-4 border-b border-gray-200/60 bg-gradient-to-r from-gray-50 to-purple-50/30">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-2xl text-purple-600">list_alt</span>
                        <h3 class="text-2xl font-bold text-gray-900">Existing Games</h3>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="material-symbols-outlined text-lg">filter_list</span>
                        @games.Count() games found
                    </div>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="flex flex-col justify-center items-center py-16">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
                    <p class="text-gray-600 text-lg font-medium">Loading games...</p>
                </div>
            }
            else if (!games.Any())
            {
                <div class="text-center py-16">
                    <div class="p-6 bg-gray-50 rounded-3xl inline-block mb-4">
                        <span class="material-symbols-outlined text-6xl text-gray-400">sports_esports</span>
                    </div>
                    <h4 class="text-xl font-semibold text-gray-600 mb-2">No Games Found</h4>
                    <p class="text-gray-500 max-w-md mx-auto">
                        No games have been added yet. Start by adding your first game above.
                    </p>
                </div>
            }
            else
            {
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100/50">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">
                                    Game Name
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">
                                    Created Date
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200/60">
                            @foreach (var game in games)
                            {
                                var isActive = game.status.ToUpper() == "ACTIVE";
                                var rowClass = isActive ? "bg-white hover:bg-gray-50/80" : "bg-gray-50/50 hover:bg-gray-100/50";
                                
                                <tr class="@rowClass transition-all duration-300">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <div class="p-2 rounded-lg bg-white shadow-sm border border-gray-200/60">
                                                <span class="material-symbols-outlined text-purple-500">
                                                    sports_esports
                                                </span>
                                            </div>
                                            <div>
                                                <div class="text-sm font-semibold text-gray-900">@game.game_name</div>
                                                <div class="text-xs text-gray-500">ID: @game.id</div>
                                            </div>
                                        </div>
                                    </td>

                                    <td class="px-6 py-4">
                                        <span class="inline-flex items-center px-3 py-1 text-xs font-bold rounded-full @(isActive ? "bg-green-100 text-green-800 border border-green-200" : "bg-red-100 text-red-800 border border-red-200")">
                                            <span class="material-symbols-outlined text-xs mr-1">
                                                @(isActive ? "check_circle" : "cancel")
                                            </span>
                                            @game.status
                                        </span>
                                    </td>

                                    <td class="px-6 py-4 text-sm text-gray-900">
                                        @game.created_at.ToString("MMM dd, yyyy")
                                    </td>

                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-2">
                                            <button @onclick='() => EditGame(game)'
                                                    class="flex items-center gap-1 px-3 py-2 text-xs bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-semibold">
                                                <span class="material-symbols-outlined text-xs">edit</span>
                                                Edit
                                            </button>
                                            <button @onclick='() => ToggleGameStatus(game)'
                                                    class="flex items-center gap-1 px-3 py-2 text-xs @(isActive ? "bg-red-100 text-red-700 hover:bg-red-200" : "bg-green-100 text-green-700 hover:bg-green-200") rounded-lg transition-colors font-semibold">
                                                <span class="material-symbols-outlined text-xs">
                                                    @(isActive ? "toggle_off" : "toggle_on")
                                                </span>
                                                @(isActive ? "Deactivate" : "Activate")
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private IEnumerable<EsGame> games = new List<EsGame>();
    private EsGame newGame = new EsGame();
    private bool isLoading = false;
    private bool isEditing = false;
    private Dictionary<string, string> validationErrors = new Dictionary<string, string>();

    protected override async Task OnInitializedAsync()
    {
        // Initialize new game with default status
        newGame.status = "ACTIVE";
        await LoadGames();
    }

    private void UpdateStatus(string status)
    {
        newGame.status = status;
        StateHasChanged();
    }

    private async Task LoadGames()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            games = await GameRepository.GetAllGamesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading games: {ex.Message}");
            // You might want to show an error message to the user here
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private bool ValidateGame()
    {
        validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(newGame.game_name))
        {
            validationErrors["game_name"] = "Game name is required";
        }
        else if (newGame.game_name.Length > 100)
        {
            validationErrors["game_name"] = "Game name must be less than 100 characters";
        }

        // Validate status
        if (string.IsNullOrWhiteSpace(newGame.status))
        {
            validationErrors["status"] = "Status is required";
        }
        else if (newGame.status != "ACTIVE" && newGame.status != "INACTIVE")
        {
            validationErrors["status"] = "Status must be either ACTIVE or INACTIVE";
        }

        return validationErrors.Count == 0;
    }

    // Helper methods for safe dictionary access
    private bool HasValidationError(string key)
    {
        return validationErrors.ContainsKey(key) && !string.IsNullOrEmpty(validationErrors[key]);
    }

    private string GetValidationError(string key)
    {
        return validationErrors.ContainsKey(key) ? validationErrors[key] : string.Empty;
    }

    private async Task AddGame()
    {
        if (!ValidateGame()) 
        {
            StateHasChanged(); // Refresh to show validation errors
            return;
        }

        try
        {
            newGame.updated_by = "ADMIN";
            newGame.center_code = "CENTER_1";
            
            var success = await GameRepository.CreateGameAsync(newGame);
            
            if (success)
            {
                newGame = new EsGame { status = "ACTIVE" }; // Reset with default status
                validationErrors.Clear();
                await LoadGames();
                
                // Show success message (you can add a toast notification here)
                Console.WriteLine("Game added successfully!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding game: {ex.Message}");
            // You might want to show an error message to the user here
        }
    }

    private async Task UpdateGame()
    {
        if (!ValidateGame()) 
        {
            StateHasChanged(); // Refresh to show validation errors
            return;
        }

        try
        {
            newGame.updated_by = "ADMIN";
            var success = await GameRepository.UpdateGameAsync(newGame);
            
            if (success)
            {
                newGame = new EsGame { status = "ACTIVE" }; // Reset with default status
                isEditing = false;
                validationErrors.Clear();
                await LoadGames();
                
                // Show success message
                Console.WriteLine("Game updated successfully!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating game: {ex.Message}");
            // You might want to show an error message to the user here
        }
    }

    private void EditGame(EsGame game)
    {
        newGame = new EsGame
        {
            id = game.id,
            game_name = game.game_name,
            status = game.status,
            updated_by = "ADMIN",
            center_code = game.center_code
        };
        isEditing = true;
        validationErrors.Clear();
        StateHasChanged();
    }

    private void CancelEdit()
    {
        newGame = new EsGame { status = "ACTIVE" }; // Reset with default status
        isEditing = false;
        validationErrors.Clear();
        StateHasChanged();
    }

    private async Task ToggleGameStatus(EsGame game)
    {
        try
        {
            var newStatus = game.status == "ACTIVE" ? "INACTIVE" : "ACTIVE";
            var success = await GameRepository.ToggleGameStatusAsync(game.id, newStatus);
            
            if (success)
            {
                await LoadGames();
                
                // Show success message
                Console.WriteLine($"Game {newStatus.ToLower()} successfully!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling game status: {ex.Message}");
            // You might want to show an error message to the user here
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/administration");
    }
}